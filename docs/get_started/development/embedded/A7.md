---
sidebar_position: 2
title: A7 STM32157 
---

To simulate the STM32MP157F A7 core we will use Yocto and QEMU. I m on Windows so i need to do it VIA WSL. I don't want to ruin my main WSL so lets do this with a second distro.

1. Download the Ubuntu WSL Image
Access the Ubuntu WSL Releases Page:

Navigate to the [Ubuntu WSL releases directory](https://cloud-images.ubuntu.com/wsl/releases/24.04/current/).
Download  `ubuntu-noble-wsl-amd64-wsl.rootfs.tar.gz` (for 64-bit systems).
Use the wsl --import command to register the new distribution:
`wsl --import UbuntuQEMU D:\WSL\QEMU C:\Path\To\ubuntu-noble-wsl-amd64-wsl.rootfs.tar.gz`

## Launch the new distribution

List Installed Distributions:
`wsl --list --verbose`
launch:
`wsl -d UbuntuQEMU`
destroy:
`wsl --list --verbose`
`wsl --unregister UbuntuQEMU`
`wsl --terminate UbuntuQEMU`

## Install packages

```sh
sudo apt update && sudo apt upgrade -y
#QEMU
sudo apt install -y qemu qemu-system-arm gcc g++ make python3 python3-pip git unzip
#Yocto
sudo apt install -y gawk wget git-core diffstat unzip texinfo gcc-multilib \
  build-essential chrpath socat cpio python3 python3-pip python3-pexpect \
  xz-utils debianutils iputils-ping libssl-dev \
  bsdmainutils git-lfs libgmp-dev libmpc-dev libsdl1.2-dev lz4 pylint python3-git xterm zstd 
sudo locale-gen en_US.UTF-8
#arm
sudo apt install qemu-system-arm
```

### start test qemu
`qemu-system-arm -M virt -cpu cortex-a7 -m 512`

### create user

```sh
adduser yoctouser
usermod -aG sudo yoctouser
su - yoctouser
```

### The new branch needs a seperate environment variable:

```sh
export BB_ENV_PASSTHROUGH_ADDITIONS="$BB_ENV_EXTRAWHITE"
unset BB_ENV_EXTRAWHITE
```

### Make the build directory:

```sh
mkdir ~/yocto
cd ~/yocto
sudo repo init -u https://github.com/STMicroelectronics/oe-manifest.git -b scarthgap
sudo repo sync
```

## Create the conf:
`source layers/meta-st/scripts/envsetup.sh`

Edit the  `build-openstlinuxweston-stm32mp15-disco/conf/local.conf`
add:

```sh
MACHINE ?= "qemuarm"
# QEMU settings for STM32MP15
# QB_SYSTEM_NAME = "qemu-system-arm"
# QB_MACHINE = "stm32mp15-disco"
# QB_KERNEL_CMDLINE = "console=ttySTM0,115200"
# QB_DEFAULT_KERNEL = "zImage"
# QB_DTB = "stm32mp157f-dk2.dtb"
# QB_OPT_APPEND = "-machine stm32mp15"
# QB_KERNEL_CMDLINE = "console=ttySTM0,115200 root=/dev/mmcblk0p4 rootwait"
# QB_DRIVE_TYPE = "/dev/mmcblk"
# QB_OPT_APPEND = "-machine stm32mp15 -cpu cortex-a7"
```

## Networking:
sudo apt-get install iptables-persistent bridge-utils uml-utilities

sudo groupadd tun
sudo usermod -a -G tun $USER
sudo ./layers/openembedded-core/scripts/runqemu-gen-tapdevs $USER 4

bitbake -c clean core-image-minimal
bitbake core-image-minimal

run:
runqemu qemuarm

## Rust

- Add layer:
  
  ```sh
    bitbake-layers add-layer /meta-hello
    cd meta-hello
    mkdir -p recipes-example/hello/files
  ```

- Ensure the same rust version:
  
  ```sh
  bitbake -e | grep RUST
  rustup install 1.75.0
  rustup override set 1.75.0
  cargo generate-lockfile
  ```

- The new scarthgap version does most of the etch and install for us
  
  Add the files we need:

  ```sh
  SRC_URI = "\
    file://Cargo.toml \
    file://Cargo.lock \
    file://src/main.rs \
  "
  ```

- Then ad the commands
  
  ```sh
  inherit cargo cargo-update-recipe-crates
  S = "${WORKDIR}"
  ```

- Add crate.import
  `require ${BPN}-crates.inc`

- Add the dependency
  `DEPENDS += "openssl-native openssl"`
  or
  `RDEPENDS:${PN} += "curl"`

- This helps cargo find the right libs

    ```sh
    export OPENSSL_DIR = "${STAGING_DIR_HOST}${prefix}"
    export OPENSSL_LIB_DIR = "${STAGING_DIR_HOST}${libdir}"
    export OPENSSL_INCLUDE_DIR = "${STAGING_DIR_HOST}${includedir}"
  ```

build the .inc for the dependencies

- create the .inc
  - `touch meta-hello/recipes-example/hello-rust/hello-rust-crates.inc`
- Build Cargo.toml
  - `cargo generate-lockfile`
- build dependencies
  - `bitbake -c update_crates hello-rust`
- Test build
  - `bitbake hello-rust`
- Build
  - `bitbake core-image-minimal`
  
### Test rust build

sudo dpkg --add-architecture armhf
sudo apt update

sudo apt-get install gcc-arm-linux-gnueabihf
sudo apt-get install libssl-dev:armhf

rustup target add armv7-unknown-linux-gnueabihf

add toml:
[target.armv7-unknown-linux-gnueabihf]
linker = "arm-linux-gnueabihf-gcc"
rustflags = [
    "-C", "link-arg=-march=armv7-a",
]

build:
OPENSSL_DIR=/usr/local/openssl-arm OPENSSL_STATIC=1 CC_armv7_unknown_linux_gnueabihf=arm-linux-gnueabihf-gcc CXX_armv7_unknown_linux_gnueabihf=arm-linux-gnueabihf-g++ cargo build --target armv7-unknown-linux-gnueabihf