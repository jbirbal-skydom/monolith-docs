---
sidebar_position: 2
title: A7 STM32MP157F Tutorial
---

To simulate the STM32MP157F A7 core, we will use Yocto and QEMU. This guide assumes you are on Windows and will use WSL for the setup. To avoid impacting your primary WSL installation, a secondary WSL distribution will be created.

## 1. Download the Ubuntu WSL Image

Access the [Ubuntu WSL Releases Page](https://cloud-images.ubuntu.com/wsl/releases/24.04/current/).

1. Download `ubuntu-noble-wsl-amd64-wsl.rootfs.tar.gz` (for 64-bit systems).
2. Use the `wsl --import` command to register the new distribution:

   ```bash
   wsl --import UbuntuQEMU D:\WSL\QEMU C:\Path\To\ubuntu-noble-wsl-amd64-wsl.rootfs.tar.gz
   ```

## 2. Launch the New Distribution

### List Installed Distributions

```bash
wsl --list --verbose
```

### Launch the New Distribution

```bash
wsl -d UbuntuQEMU
```

### Destroy the Distribution (if needed)

```bash
wsl --terminate UbuntuQEMU
wsl --unregister UbuntuQEMU
```

## 3. Install Required Packages

Update and upgrade the system:

```bash
sudo apt update && sudo apt upgrade -y
```

Install QEMU, Yocto dependencies, and other tools:

```bash
sudo apt install -y qemu qemu-system-arm gcc g++ make python3 python3-pip git unzip

sudo apt install -y gawk wget git-core diffstat texinfo gcc-multilib \
  build-essential chrpath socat cpio python3-pexpect xz-utils \
  iputils-ping libssl-dev bsdmainutils git-lfs libgmp-dev libmpc-dev \
  libsdl1.2-dev lz4 pylint python3-git xterm zstd

sudo locale-gen en_US.UTF-8
```

## 4. Test QEMU

To verify the installation of QEMU:

```bash
qemu-system-arm -M virt -cpu cortex-a7 -m 512
```

## 5. Create a New User

Add a new user for Yocto development:

```bash
sudo adduser yoctouser
sudo usermod -aG sudo yoctouser
su - yoctouser
```

## 6. Configure Yocto Environment

### Set Environment Variables

Add the following to your environment:

```bash
export BB_ENV_PASSTHROUGH_ADDITIONS="$BB_ENV_EXTRAWHITE"
unset BB_ENV_EXTRAWHITE
```

### Create the Build Directory

1. Create and navigate to the Yocto directory:

   ```bash
   mkdir ~/yocto
   cd ~/yocto
   ```

2. Initialize and sync the repo:

   ```bash
   repo init -u https://github.com/STMicroelectronics/oe-manifest.git -b scarthgap
   repo sync
   ```

### Create the Configuration File

Source the environment setup script:

```bash
source layers/meta-st/scripts/envsetup.sh
```

Edit `build-openstlinuxweston-stm32mp15-disco/conf/local.conf` and add:

```bash
MACHINE ?= "qemuarm"
# QEMU settings for STM32MP15
# QB_SYSTEM_NAME = "qemu-system-arm"
# QB_MACHINE = "stm32mp15-disco"
# QB_KERNEL_CMDLINE = "console=ttySTM0,115200"
# QB_DEFAULT_KERNEL = "zImage"
# QB_DTB = "stm32mp157f-dk2.dtb"
# QB_OPT_APPEND = "-machine stm32mp15 -cpu cortex-a7"
```

## 7. Networking Configuration

Install additional packages:

```bash
sudo apt-get install -y iptables-persistent bridge-utils uml-utilities
```

Configure networking for QEMU:

```bash
sudo groupadd tun
sudo usermod -a -G tun $USER
sudo ./layers/openembedded-core/scripts/runqemu-gen-tapdevs $USER 4
```

Build and run the image:

```bash
bitbake -c clean core-image-minimal
bitbake core-image-minimal
runqemu qemuarm
```

## 8. Adding Rust Support

### Add a Custom Layer

```bash
bitbake-layers add-layer /meta-hello
cd meta-hello
mkdir -p recipes-example/hello/files
```

### Ensure Rust Version

```bash
bitbake -e | grep RUST
rustup install 1.75.0
rustup override set 1.75.0
cargo generate-lockfile
```

### Configure Rust Recipe

Add the following to `SRC_URI`:

```bash
SRC_URI = "\
  file://Cargo.toml \
  file://Cargo.lock \
  file://src/main.rs \
"
```

Add recipe inheritance and settings:

```bash
inherit cargo cargo-update-recipe-crates
S = "${WORKDIR}"
```

Add dependencies:

```bash
DEPENDS += "openssl-native openssl"
RDEPENDS:${PN} += "curl"
```

Add OpenSSL environment variables:

```bash
export OPENSSL_DIR="${STAGING_DIR_HOST}${prefix}"
export OPENSSL_LIB_DIR="${STAGING_DIR_HOST}${libdir}"
export OPENSSL_INCLUDE_DIR="${STAGING_DIR_HOST}${includedir}"
```

### Build the .inc File for Dependencies

1. Create the `.inc` file:

   ```bash
   touch meta-hello/recipes-example/hello-rust/hello-rust-crates.inc
   ```

2. Generate `Cargo.toml` dependencies:

   ```bash
   cargo generate-lockfile
   ```

3. Update and build:

   ```bash
   bitbake -c update_crates hello-rust
   bitbake hello-rust
   bitbake core-image-minimal
   ```

### Test the Rust Build

Add ARM architecture support:

```bash
sudo dpkg --add-architecture armhf
sudo apt update
sudo apt-get install gcc-arm-linux-gnueabihf libssl-dev:armhf
rustup target add armv7-unknown-linux-gnueabihf
```

Update `Cargo.toml` for ARM builds:

```toml
[target.armv7-unknown-linux-gnueabihf]
linker = "arm-linux-gnueabihf-gcc"
rustflags = [
    "-C", "link-arg=-march=armv7-a",
]
```

Build the project:

```bash
OPENSSL_DIR=/usr/local/openssl-arm OPENSSL_STATIC=1 \
CC_armv7_unknown_linux_gnueabihf=arm-linux-gnueabihf-gcc \
CXX_armv7_unknown_linux_gnueabihf=arm-linux-gnueabihf-g++ \
cargo build --target armv7-unknown-linux-gnueabihf
```
